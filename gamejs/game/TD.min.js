!function(t){var e=function(){this.target=null,this.canvas=null,this.gameboard=null,this.userList=[]};e.prototype=new Sprite,JY.extend(e.prototype,{create:function(t){this.init(30*t.length,30),this.setStyle({border:"1px solid #AAA",borderRadius:"5px",backgroundColor:"#00FF7F",zIndex:3});var e=this;JY.each(t,function(t,i){var r=new n[t.type];r.range=t.range,r.parent=e,r.selectTab=e,r.money=t.money,r.attack=t.attack,r.Mattack=t.Mattack,r.description(),r.setPosition(30*i),e.userList.push(r),e.addChild(r)})},AddUser:function(t){this.parent.userArr.push(t)},show:function(t){this.target=t,this.setPosition(t.x-this.width/2+t.width/2,t.y-this.height-10),this.setStyle({display:"block"}),_self=this,JY.each(_self.userList,function(t,e){t.target=_self.target,t.canvas=_self.canvas,t.gameboard=_self.gameboard})},hide:function(){this.setStyle({display:"none"})}});var i=function(){};i.prototype=new Sprite,JY.extend(i.prototype,{create:function(){this.init(30,30),this.setStyle({border:"1px solid #AAA",borderRadius:"5px",backgroundColor:"#00FF7F"});var t=this;JY.append(t.DOM,"up"),t.gameboard.addChild(this),t.bindEvent()},bindEvent:function(){var t=this;JY.bind(this.DOM,"mousedown",function(){t.target.level<3&&t.target.levelup(),JY.remove(t.DOM),t=null})},show:function(){this.setPosition(this.target.x-this.width/2+this.target.width/2,this.target.y-this.height-10),this.setStyle({display:"block"})},hide:function(){this.setStyle({display:"none"})}});var n={};n.USER=function(){this.type=0,this.speed=10,this.target=null,this.level=1,this.gameboard=null,this.canvas=null,this.user=null},n.USER.inherits(Sprite),n.USER.method({structure:function(){},move:function(t){},showIcon:function(){this.setStyle({background:"blue"})},description:function(){this.init(),this.width=30,this.height=30,this.setStyle({width:this.width+"px",height:this.height+"px",cursor:"pointer"});var t=new Sprite(30,12);JY.append(t.DOM,"$"+this.money),t.setStyle({color:"blue",bottom:0,fontWeight:"bold",fontStyle:"normal",fontSize:"12px"}),this.addChild(t),this.showIcon(),this.bindEvent()},bindEvent:function(){var t=this;JY.hover(this.DOM,function(){JY.css(this,{opacity:.7}),t.drawRange()},function(){JY.css(this,{opacity:1}),t.clearRange()}),JY.bind(this.DOM,"mousedown",function(){t.create()})},drawRange:function(){this.clearRange(),this.canvas.beginPath(),this.canvas.strokeStyle="#aaa",this.canvas.arc(this.target.x+this.target.width/2,this.target.y+this.target.height/2,this.range,0,2*Math.PI,!1),this.canvas.stroke()},clearRange:function(){this.canvas.clearRect(0,0,JY.width(this.canvas.canvas),JY.height(this.canvas.canvas))},Attack:function(){},_init:function(){this.init(),this.width=32,this.height=32,this.y=0,this.setStyle({border:"1px solid blue",width:this.width+"px",height:this.height+"px"}),this.structure()},dispose:function(t){this.f=t||this.f}}),n.archerTower=function(){this.type=1},n.archerTower.inherits(n.USER),n.archerTower.method({showIcon:function(){this.bgimg="url(images/TD/archerTower.png) center center no-repeat",this.setStyle({background:this.bgimg})},create:function(){return g.money<this.money?!1:(g.money-=this.money,this.user=new s(30,30),this.user.bgimg=this.bgimg,this.user.attack=this.attack,this.user.Mattack=this.Mattack,this.user.money=this.money,this.user.create(this,this.gameboard),this.user.canvas=this.canvas,this.selectTab.hide(),void this.parent.AddUser(this.user))}});var r=function(){this.ctx=null,this.width=2,this.speed=10,this.target=null,this.toObj=null,this.attack=100,this.Mattack=10,this.life=1};JY.extend(r.prototype,{init:function(t,e,i){this.ctx=i,this.target=t,this.x=t.x+t.width/2,this.y=t.y+t.height/2,this.toObj=e,this.ctx.fillStyle="red",this.ctx.beginPath(),this.ctx.save(),this.ctx.arc(this.x,this.y,this.width,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.restore()},move:function(){if(!this.toObj||this.life<=0||this.toObj.del)return!1;var t=this.toObj.x+this.toObj.width/2-this.x,e=this.toObj.y+this.toObj.height/2-this.y,i=Math.atan2(t,e);this.x+=Math.floor(Math.sin(i)*this.speed),this.y+=Math.floor(Math.cos(i)*this.speed),this.ctx.beginPath(),this.ctx.arc(this.x,this.y,this.width,0,2*Math.PI,!1),this.ctx.stroke();{var n=this.x-this.target.x,r=this.y-this.target.y;Math.sqrt(n*n+r*r)}JY.hits(this,this.toObj)&&(this.toObj.life=this.toObj.life-Math.max(0,this.attack-this.toObj.Def)-Math.max(0,this.Mattack-this.toObj.MDef),this.life=0,this.toObj.life<=0&&(this.toObj.del=!0,l.removeChild(this.toObj),g.money+=this.toObj.money,delete this.toObj,g.moveMonsterArr[this.index]=null,delete g.moveMonsterArr[this.index]))}}),n.MTower=function(){},n.MTower.inherits(n.archerTower),n.MTower.method({showIcon:function(){this.bgimg="url(images/TD/Mtower.png) center center no-repeat",this.setStyle({background:this.bgimg})}}),n.MATower=function(){},n.MATower.inherits(n.archerTower),n.MATower.method({showIcon:function(){this.bgimg="url(images/TD/MATower.gif) center center no-repeat",this.setStyle({background:this.bgimg})}});var s=function(){this.range=100,this.canvas=null};s.prototype=new Sprite,JY.extend(s.prototype,{fire:function(t,e,i){var n=new r;n.index=i,n.attack=this.attack,n.Mattack=this.Mattack,n.init(this,t,e),g.bulletArr.push(n)},create:function(t,e){this.init(30,30),this.setPosition(t.target.x,t.target.y),this.level=1,this.range=t.range,this.gameboard=e,this.setStyle({background:this.bgimg}),this.gameboard.addChild(this),this.levelInfo=new Sprite(30,12),JY.css(this.levelInfo.DOM,{fontSize:"10px",fontStyle:"normal",color:"blue",fontWeight:"bold"}),this.levelInfo.setPosition(5,18),JY.append(this.levelInfo.DOM,"lv."+this.level),this.addChild(this.levelInfo),JY.remove(t.target.DOM),this.bindUpEvent()},levelup:function(){return g.money<this.money*this.level?!1:(g.money-=this.money*this.level,this.level++,this.range*=1.1,this.attack*=1.1,this.Mattack*=1.1,void(this.levelInfo.DOM.innerHTML="lv."+this.level))},bindUpEvent:function(){var t=this;JY.bind(t.DOM,"mousedown",function(){var e=new i;e.target=t,e.gameboard=t.gameboard,e.create(),e.show()}),JY.hover(t.DOM,function(){t.drawRange()},function(){t.clearRange()})},clearRange:function(){this.canvas.clearRect(0,0,JY.width(this.canvas.canvas),JY.height(this.canvas.canvas))},drawRange:function(){this.clearRange(),this.canvas.beginPath(),this.canvas.strokeStyle="#aaa",this.canvas.arc(this.x+this.width/2,this.y+this.height/2,this.range,0,2*Math.PI,!1),this.canvas.stroke()}});var o=function(){};o.prototype=new Sprite,JY.extend(o.prototype,{create:function(t){this.init(50,50,{backgroundColor:"#FFFFFF",borderRadius:"5px",fontStyle:"normal",fontSize:"16px",fontWeight:"bold",fontFamily:"微软雅黑",color:"#4d4d4d",lineHeight:"50px",textAlign:"center",cursor:"pointer"}),this.DOM.innerHTML=t}});var a={};a.base=function(){this.index=0,this.speed=10},a.base.prototype=new Sprite,JY.extend(a.base.prototype,{create:function(){this.init(30,30,{background:"url(images/TD/monster.gif) center center no-repeat"})}}),a.monster1=function(){},a.monster1.prototype=new a.base,a.monster2=function(){},a.monster2.prototype=new a.base,JY.extend(a.monster2.prototype,{create:function(){this.init(30,30,{background:"url(images/TD/monster2.png) center center no-repeat"})}}),a.monster3=function(){},a.monster3.prototype=new a.base,JY.extend(a.monster3.prototype,{create:function(){this.init(30,30,{background:"url(images/TD/monster3.png) center center no-repeat"})}}),a.monster4=function(){},a.monster4.prototype=new a.base,JY.extend(a.monster4.prototype,{create:function(){this.init(30,30,{background:"url(images/TD/monster4.gif) center center no-repeat"})}}),a.monster5=function(){},a.monster5.prototype=new a.base,JY.extend(a.monster5.prototype,{create:function(){this.init(50,50,{background:"url(images/TD/monster5.png) center center no-repeat"})}});var h=function(){},c=function(){};c.prototype=new Game,g=new c,JY.extend(c.prototype,{newGame:function(){this.levelArr=["level1","level2","level3","level3","level4","level5","level6"],this.levelKey=["!@#","#@!","sa","erq","!@#1","#@!2","sa中","fe3","!sel","iow!","q3","6ff","56w","al3","3d","a3d","3LK","ailk","@#%D","$#$","!^^","SE!","WD","BDA","MC","WC!","EFS","DE"],this.levelGrade=[],this.levelSpriteArr=[],this.currentLevel=1,this.currentLevelArr=[],this.pointArr=[],this.positionList=[],this.currentConfig={},t.levelObject={},this.lastPoint=null,this.life=10,this.lifeScreen=null,this.user=null,this.money=100,this.moneyScreen=null,this.shiArr=[],this.speed=5,this.mapCxt=JY.getCtx("path"),this.monsterCxt=JY.getCtx("monster"),this.actionCxt=JY.getCtx("action"),this.monsterArr=[],this.monsterbatch=0,this.monsterMoveWait=10,this.moveMonsterArr=[],this.userArr=[],this.bulletArr=[],this.fireCounter=10,this.showLevel(),JY.soundManage.play("bg",!0)},showLevel:function(){this.mapCxt.clearRect(0,0,640,640),l.clearState();var t=this;JY.each(this.levelArr,function(e,i){var n=new o;n.create(i+1),n.data=i+1,l.addChild(n);var r=i%8*(n.width+10)+100,s=parseInt(i/8)*(n.height+10)+100;n.setPosition(r,s),t.levelSpriteArr.push(n);var a=JY.cookie("TDlevel")||1,h=JY.cookie("TDlevelKey")||"!@#";t.levelKey[a]!==h&&(a=1),i+1>a&&(n.setStyle({backgroundColor:"gray"}),n.lock=!0)}),this.selectLevel()},selectLevel:function(){var t=this;JY.each(t.levelSpriteArr,function(e,i){!function(e){JY.bind(e.DOM,"mousedown",function(i){e.lock||t.startLevel(e.data)})}(e)})},startLevel:function(t){l.clearState();var e=this;this.currentLevel=t,this.monsterbatch=0,this.userArr=[],this.monsterCxt.clearRect(0,0,640,640),this.mapCxt.clearRect(0,0,640,640),this.actionCxt.clearRect(0,0,640,640),e.life=10,JY.loadFile("/game/level/TD/level"+t+".js","script",function(){e.drawMap()}),e.moneyScreen=new Sprite(150,20,{right:"0px",top:0,background:"gray",fontStyle:"normal"}),l.addChild(e.moneyScreen),e.lifeScreen=new Sprite(202,22,{left:"0px",top:0,border:"1px solid red",borderRadius:"5px",backgroundColor:"#FFF"}),l.addChild(e.lifeScreen)},drawMap:function(){var e=this;e.currentLevelArr=t.levelObject["level"+e.currentLevel].map,e.currentConfig=t.levelObject["level"+e.currentLevel].config,e.path=e.currentLevelArr.path,e.positionArr=e.currentLevelArr.position,e.money=e.currentConfig.money,e.mapCxt.save();var i=e.mapCxt.createLinearGradient(0,0,640,0);i.addColorStop("0","magenta"),i.addColorStop("0.5","rgba(233,233,100,0.5)"),i.addColorStop("1.0","rgba(233,0,100,0.5)"),e.mapCxt.strokeStyle=i,e.mapCxt.lineWidth=20,e.mapCxt.lineJoin="round",e.mapCxt.beginPath(),JY.each(e.path,function(t){e.mapCxt.moveTo(t[0].start.x,t[0].start.y),JY.resolve(function(t,i){e.mapCxt.lineTo(t.end.x,t.end.y),e.mapCxt.stroke()},0,t.length,t)}),e.mapCxt.restore(),JY.each(e.positionArr,function(t){var i=new Sprite(t.w,t.h);i.setStyle({backgroundColor:"#efefef",border:"1px dashed #AAA",borderRadius:"5px",cursor:"pointer"}),i.setPosition(t.x,t.y),l.addChild(i),e.positionList.push(i)}),this.bindEvent(),e.createSelectTab(),this.createMonster(),l.startTimer()},createMonster:function(){var t=this,e=t.currentConfig.monster;JY.each(e,function(e,i){for(;e.num--;){var n=new a[e.type];n.create(),n.batch=i,n.arrIndex=0,JY.extend(n,e),t.monsterArr.push(n);var r=t.path[e.index][0].start;n.setPosition(r.x-15,r.y-15),l.addChild(n)}})},createCrystal:function(){this.user=new Sprite(16,20,{border:"none",background:"url(images/movehoop/fire.gif) -3px 0px no-repeat"}),this.user.setPosition(0,JY.height(l.stage)/2),l.addChild(this.user)},bindEvent:function(){var t=this;JY.each(t.positionList,function(e,i){JY.bind(e.DOM,"mousedown",function(i){t.showSelect(e)}),JY.hover(e.DOM,function(){JY.css(this,{backgroundColor:"#F0F8FF",border:"1px solid #AAA"})},function(){JY.css(this,{backgroundColor:"#efefef",border:"1px dashed #AAA"})})})},createSelectTab:function(){this.tab=new e,this.tab.create(this.currentConfig.user),this.tab.hide(),this.tab.gameboard=l,this.tab.parent=this,l.addChild(this.tab)},showSelect:function(t){this.tab.canvas=JY.getCtx("action"),this.tab.show(t)},runGame:function(){this.checkLife(),this.runMonster(),this.moveBullet(),this.testHits()},moveBullet:function(){var t=this;t.monsterCxt.clearRect(0,0,640,640),JY.each(t.bulletArr,function(e,i){e.toObj?e.move():(e=null,delete t.bulletArr[i])})},testHits:function(){var t=this;t.fireCounter<0&&(t.fireCounter=10,JY.resolve(function(e,i){JY.each(t.moveMonsterArr,function(i,n){var r=i.x-e.x,s=i.y-e.y,o=Math.floor(Math.sqrt(r*r+s*s));return o<=e.range?(e.fire(i,t.monsterCxt,n),!1):void 0})},0,t.userArr.length,t.userArr)),t.fireCounter--},runMonster:function(){var t=this;t.monsterArr.length>0&&t.monsterMoveWait<=0&&t.monsterArr[0].batch==t.monsterbatch&&(t.monsterMoveWait=10,t.moveMonsterArr.push(t.monsterArr.shift())),JY.resolve(function(e,i){if(e.batch==t.monsterbatch){var n=t.path[e.index],r=n[e.arrIndex];if(n.length==e.arrIndex)return l.removeChild(e),delete e,t.moveMonsterArr[i]="",void t.life--;var s=r.end.x-r.start.x,o=r.end.y-r.start.y,a=Math.atan2(s,o);e.x+=Math.sin(a)*e.speed,e.y+=Math.cos(a)*e.speed;var h={x:e.x+e.width/2,y:e.y+e.height/2};if(Math.abs(h.x-r.end.x)<=10&&Math.abs(h.y-r.end.y)<=10){var c=!1;r.start.y>r.end.y?r.end.y-h.y>-5&&r.end.y-h.y<=5&&(c=!0):c=!0,c&&(e.arrIndex++,e.arrIndex<n.length&&(e.x=n[e.arrIndex].start.x-e.width/2,e.y=n[e.arrIndex].start.y-e.height/2))}e.setPosition(e.x,e.y)}},0,t.moveMonsterArr.length,t.moveMonsterArr),t.monsterMoveWait--,""==t.moveMonsterArr.join("")&&0!==t.moveMonsterArr.length&&(t.monsterbatch++,t.moveMonsterArr=[])},checkStage:function(){JY.height(l.stage)!==l.stage.height&&JY.height(l.stage,l.stage.height),JY.width(l.stage)!==l.stage.width&&JY.width(l.stage,l.stage.width)},checkLife:function(){return this.moneyScreen.DOM.innerHTML="当前金钱："+this.money+"$",this.lifeScreen.DOM.innerHTML='<i style="width:'+20*this.life+'px;height:20px;margin:1px;background:red;display:block;border-radius:5px;"></i>',this.life<=0?(l.clearState(),this.newGame(),JY.soundManage.stop("bg",!0),!1):void(0==this.monsterArr.length&&0==this.moveMonsterArr.length&&this.levelup())},levelup:function(){var t=this.life;JY.cookie("TDlevelGrade",JY.cookie("TDlevelGrade")+"%"+this.levelGrade[this.currentLevel]+"|"+t),this.currentLevel++;var e=JY.cookie("TDlevel")||1;e=Math.max(this.currentLevel,e),JY.cookie("TDlevel",e,30),JY.cookie("TDlevelKey",this.levelKey[e],30),this.startLevel(this.currentLevel)}}),h.prototype=new JYG(JY.byId("gameboard")),JY.extend(h.prototype,{init:function(){this.frequency=50,this.game=g,this.waitTime=5,this.checkState(JYGSTATE.STATE_SYSTEM_TITLE),this.startTimer(),this.titleScreen=JY.convertDOM('<div style="color:red;font-weight:bold;text-align:center;padding-top:50px;width:100%;margin:0 auto;"><h1 style="color:red;font-weight:bold;">魔兽争霸-塔防-JY游戏</h1></div>'),this.InstructionsScreen=JY.convertDOM('<div style="margin:0 auto;height:100%;width:100%;position:relative;"><span style="display:block;cursor:pointer;width:275px;height:110px;line-height:100px;font-family: Tahoma,宋体;text-align:center;font-size:28px;font-weight:bolder;color:#FFFFFF;top:200px;left:180px;position:absolute;">Play</span><p style="position:absolute;top:350px;left:180px;color:#0091e0;"><a href="http://www.lovewebgames.com" target="_blank" style="color:#0091e0;">作者：田想兵55342775@qq.com</a></p></div>'),this.scoreScreen=JY.convertDOM('<div style="color:#FFF;width:200px;float:right;font-weight:bold;position:absolute;z-index:2;right:0;" id="scoreScreen"></div>'),JY.delegate(JY.byId("gameboard"),"a","mousedown",function(t){location.href=JY.attr(t.target,"href")}),JY.soundManage.init("/scripts/swfobject.min.js","/scripts/flash/playSound.swf","playSound",function(){JY.soundManage.loadSound("/game/sound/zuma/bg.mp3","bg")});var t=JY.convertDOM('<p style="font-size:12px;">资源正在加载中。。。</p>');this.addChild(t);var e=this;JY.loadFile("/scripts/JY.cookie.js","script",function(){e.removeChild(t)})}});var l=new h;l.init(),"www.lovewebgames.com"!==location.host&&"localhost"!==location.hostname&&(location.href="http://www.lovewebgames.com")}(window);